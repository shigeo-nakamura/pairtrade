name: Deploy Configs

on:
  push:
    paths:
      - "configs/**"
      - "scripts/**"
      - "deploy/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-central-1
  INSTALL_DIR: /opt/debot

jobs:
  deploy-configs:
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}
    environment: debot
    steps:
      - name: Checkout debot
        uses: actions/checkout@v4
        with:
          path: debot

      - name: Package artifacts
        run: |
          mkdir -p dist/scripts dist/configs
          rsync -a \
            --exclude "venv/" \
            --exclude "__pycache__/" \
            --exclude "*.log" \
            --exclude "*.pyc" \
            debot/scripts/ dist/scripts/
          rsync -a debot/configs/ dist/configs/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN || vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload artifacts to S3
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET || vars.S3_BUCKET }}
        run: |
          aws s3 sync dist/scripts/ "s3://${S3_BUCKET}/debot/scripts/" \
            --exclude "venv/*" \
            --exclude "venv/**" \
            --exclude "__pycache__/*" \
            --exclude "__pycache__/**" \
            --exclude "*.log" \
            --exclude "*.pyc"
          aws s3 sync dist/configs/ "s3://${S3_BUCKET}/debot/configs/"
          aws s3 cp debot/deploy/debot00.service "s3://${S3_BUCKET}/deploy/debot00.service"
          aws s3 cp debot/deploy/debot01.service "s3://${S3_BUCKET}/deploy/debot01.service"
          aws s3 cp debot/deploy/debot02.service "s3://${S3_BUCKET}/deploy/debot02.service"
          aws s3 cp debot/deploy/debot03.service "s3://${S3_BUCKET}/deploy/debot03.service"

      - name: Deploy via SSM (no restart)
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET || vars.S3_BUCKET }}
          INSTANCE_ID: ${{ secrets.INSTANCE_ID || vars.INSTANCE_ID }}
        run: |
          cat > /tmp/ssm-params.json <<'JSON'
          {
            "commands": [
              "sudo mkdir -p __INSTALL_DIR__/scripts __INSTALL_DIR__/configs",
              "aws s3 sync s3://__S3_BUCKET__/debot/scripts __INSTALL_DIR__/scripts",
              "aws s3 sync s3://__S3_BUCKET__/debot/configs __INSTALL_DIR__/configs",
              "sudo chmod 755 __INSTALL_DIR__/scripts/*.sh",
              "/bin/bash -lc 'set -e; UPDATED=0; for svc in debot00 debot01 debot02 debot03; do aws s3 cp s3://__S3_BUCKET__/deploy/$svc.service /tmp/$svc.service; if [ ! -f /etc/systemd/system/$svc.service ] || ! cmp -s /etc/systemd/system/$svc.service /tmp/$svc.service; then sudo mv /tmp/$svc.service /etc/systemd/system/$svc.service; UPDATED=1; else rm /tmp/$svc.service; fi; done; if [ $UPDATED -eq 1 ]; then sudo systemctl daemon-reload; fi'"
            ]
          }
          JSON
          sed -i "s|__INSTALL_DIR__|${INSTALL_DIR}|g; s|__S3_BUCKET__|${S3_BUCKET}|g" /tmp/ssm-params.json

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy debot configs/scripts" \
            --parameters file:///tmp/ssm-params.json \
            --query "Command.CommandId" \
            --output text)

          set +e
          aws ssm wait command-executed --command-id "${COMMAND_ID}" --instance-id "${INSTANCE_ID}"
          WAIT_STATUS=$?
          aws ssm get-command-invocation --command-id "${COMMAND_ID}" --instance-id "${INSTANCE_ID}" --output text
          set -e
          if [ $WAIT_STATUS -ne 0 ]; then
            echo "SSM command failed with status ${WAIT_STATUS}" >&2
            exit $WAIT_STATUS
          fi
